<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading AI Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .header {
            background-color: #1a1a1a;
            color: white;
            padding: 1rem;
            margin: -20px -20px 20px -20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .stat {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        .profit-value {
            font-weight: bold;
        }
        .positive {
            color: #4CAF50;
        }
        .negative {
            color: #f44336;
        }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
            position: relative;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .metric-label {
            font-size: 0.9em;
            color: #666;
        }
        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }
        @media (max-width: 600px) {
            .dashboard, .charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trading AI Dashboard</h1>
        <div id="account-info" style="text-align: right">
            <div>Balance: <span id="balance">$0</span></div>
            <div>Account: <span id="account-number">0</span></div>
        </div>
    </div>
    
    <div class="dashboard">
        <div class="card">
            <div class="stat">
                <div>
                    <div class="stat-value" id="totalTrades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="stat">
                <div>
                    <div class="stat-value" id="totalProfit">$0</div>
                    <div class="stat-label">Total Profit</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="stat">
                <div>
                    <div class="stat-value" id="winRate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="stat">
                <div>
                    <div class="stat-value" id="maxDrawdown">0%</div>
                    <div class="stat-label">Max Drawdown</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Advanced Performance Metrics</div>
        <div class="performance-metrics">
            <div class="metric-card">
                <div class="metric-label">Profit Factor</div>
                <div class="metric-value" id="profitFactor">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Trade</div>
                <div class="metric-value" id="avgTrade">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Max Profit Trade</div>
                <div class="metric-value" id="maxProfit">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Max Loss Trade</div>
                <div class="metric-value" id="maxLoss">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Win</div>
                <div class="metric-value" id="avgWin">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Loss</div>
                <div class="metric-value" id="avgLoss">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Consecutive Wins</div>
                <div class="metric-value" id="maxConsWins">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Consecutive Losses</div>
                <div class="metric-value" id="maxConsLosses">0</div>
            </div>
        </div>
    </div>

    <div class="charts">
        <div class="chart-container">
            <div class="card-header">Order Distribution</div>
            <canvas id="orderDistribution"></canvas>
        </div>
        <div class="chart-container">
            <div class="card-header">TP/SL Statistics</div>
            <canvas id="tpslStats"></canvas>
        </div>
        <div class="chart-container">
            <div class="card-header">Cumulative Profit</div>
            <canvas id="dailyProfit"></canvas>
        </div>
        <div class="chart-container">
            <div class="card-header">Symbol Performance</div>
            <canvas id="symbolPerformance"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Symbol Analysis</div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Total Trades</th>
                        <th>Win Rate</th>
                        <th>Total Profit</th>
                        <th>Average Profit</th>
                        <th>Max Drawdown</th>
                        <th>Profit Factor</th>
                    </tr>
                </thead>
                <tbody id="symbolAnalysisTable">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let charts = {
            orderDistribution: null,
            tpslStats: null,
            dailyProfit: null,
            symbolPerformance: null
        };

        async function loadTradingData() {
            try {
                const response = await fetch('/api/trading-history');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const trades = await response.json();
                updateDashboard(trades);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function calculateStats(trades) {
            if (!trades || !trades.length) return null;

            const stats = {
                totalTrades: trades.length,
                buyTrades: trades.filter(t => t.type === 0).length,
                sellTrades: trades.filter(t => t.type === 1).length,
                tpHits: trades.filter(t => t.close_reason === 'tp').length,
                slHits: trades.filter(t => t.close_reason === 'sl').length,
                manualCloses: trades.filter(t => t.close_reason === 'manual').length,
                totalProfit: trades.reduce((sum, t) => sum + t.profit, 0),
                symbols: [...new Set(trades.map(t => t.symbol))],
                maxProfit: Math.max(...trades.map(t => t.profit)),
                maxLoss: Math.min(...trades.map(t => t.profit)),
                symbolStats: {}
            };

            // Calculate win rate
            const winningTrades = trades.filter(t => t.profit > 0);
            stats.winRate = (winningTrades.length / trades.length) * 100;

            // Calculate drawdown
            let peak = 0;
            let maxDrawdown = 0;
            let runningProfit = 0;
            trades.forEach(trade => {
                runningProfit += trade.profit;
                if (runningProfit > peak) peak = runningProfit;
                const drawdown = ((peak - runningProfit) / peak) * 100;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            });
            stats.maxDrawdown = maxDrawdown;

            // Calculate profit factor
            const grossProfit = trades.filter(t => t.profit > 0).reduce((sum, t) => sum + t.profit, 0);
            const grossLoss = Math.abs(trades.filter(t => t.profit < 0).reduce((sum, t) => sum + t.profit, 0));
            stats.profitFactor = grossLoss ? grossProfit / grossLoss : grossProfit;

            // Calculate average trades
            stats.avgTrade = stats.totalProfit / stats.totalTrades;
            stats.avgWin = winningTrades.reduce((sum, t) => sum + t.profit, 0) / winningTrades.length;
            stats.avgLoss = trades.filter(t => t.profit < 0).reduce((sum, t) => sum + t.profit, 0) / 
                           (stats.totalTrades - winningTrades.length);

            // Calculate consecutive trades
            let consWins = 0;
            let consLosses = 0;
            let maxConsWins = 0;
            let maxConsLosses = 0;
            let currentWins = 0;
            let currentLosses = 0;

            trades.forEach(trade => {
                if (trade.profit > 0) {
                    currentWins++;
                    currentLosses = 0;
                    if (currentWins > maxConsWins) maxConsWins = currentWins;
                } else {
                    currentLosses++;
                    currentWins = 0;
                    if (currentLosses > maxConsLosses) maxConsLosses = currentLosses;
                }
            });

            stats.maxConsWins = maxConsWins;
            stats.maxConsLosses = maxConsLosses;

            // Calculate per-symbol statistics
            stats.symbols.forEach(symbol => {
                const symbolTrades = trades.filter(t => t.symbol === symbol);
                const symbolWinningTrades = symbolTrades.filter(t => t.profit > 0);
                const symbolProfits = symbolTrades.map(t => t.profit);
                let peakEquity = 0;
                let maxSymbolDrawdown = 0;
                let runningProfit = 0;

                symbolTrades.forEach(trade => {
                    runningProfit += trade.profit;
                    if (runningProfit > peakEquity) peakEquity = runningProfit;
                    const drawdown = ((peakEquity - runningProfit) / peakEquity) * 100;
                    if (drawdown > maxSymbolDrawdown) maxSymbolDrawdown = drawdown;
                });

                const symbolGrossProfit = symbolTrades.filter(t => t.profit > 0)
                    .reduce((sum, t) => sum + t.profit, 0);
                const symbolGrossLoss = Math.abs(symbolTrades.filter(t => t.profit < 0)
                    .reduce((sum, t) => sum + t.profit, 0));

                stats.symbolStats[symbol] = {
                    trades: symbolTrades.length,
                    winRate: (symbolWinningTrades.length / symbolTrades.length) * 100,
                    totalProfit: symbolTrades.reduce((sum, t) => sum + t.profit, 0),
                    avgProfit: symbolTrades.reduce((sum, t) => sum + t.profit, 0) / symbolTrades.length,
                    maxDrawdown: maxSymbolDrawdown,
                    profitFactor: symbolGrossLoss ? symbolGrossProfit / symbolGrossLoss : symbolGrossProfit
                };
            });

            return stats;
        }

        function updateDashboard(trades) {
            const stats = calculateStats(trades);
            if (!stats) return;

            // Update main statistics
            document.getElementById('totalTrades').textContent = stats.totalTrades;
            document.getElementById('totalProfit').textContent = `$${stats.totalProfit.toFixed(2)}`;
            document.getElementById('winRate').textContent = `${stats.winRate.toFixed(1)}%`;
            document.getElementById('maxDrawdown').textContent = `${stats.maxDrawdown.toFixed(1)}%`;

            // Update advanced metrics
            document.getElementById('profitFactor').textContent = stats.profitFactor.toFixed(2);
            document.getElementById('avgTrade').textContent = `$${stats.avgTrade.toFixed(2)}`;
            document.getElementById('maxProfit').textContent = `$${stats.maxProfit.toFixed(2)}`;
            document.getElementById('maxLoss').textContent = `$${stats.maxLoss.toFixed(2)}`;
            document.getElementById('avgWin').textContent = `$${stats.avgWin.toFixed(2)}`;
            document.getElementById('avgLoss').textContent = `$${stats.avgLoss.toFixed(2)}`;
            document.getElementById('maxConsWins').textContent = stats.maxConsWins;
            document.getElementById('maxConsLosses').textContent = stats.maxConsLosses;

            // Update symbol analysis table
            const tableBody = document.getElementById('symbolAnalysisTable');
            tableBody.innerHTML = '';
            
            Object.entries(stats.symbolStats).forEach(([symbol, symbolStat]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${symbol}</td>
                    <td>${symbolStat.trades}</td>
                    <td>${symbolStat.winRate.toFixed(1)}%</td>
                    <td class="${symbolStat.totalProfit >= 0 ? 'positive' : 'negative'}">
                        $${symbolStat.totalProfit.toFixed(2)}
                    </td>
                    <td class="${symbolStat.avgProfit >= 0 ? 'positive' : 'negative'}">
                        $${symbolStat.avgProfit.toFixed(2)}
                    </td>
                    <td>${symbolStat.maxDrawdown.toFixed(1)}%</td>
                    <td>${symbolStat.profitFactor.toFixed(2)}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update charts
            updateCharts(stats, trades);
        }

        function updateCharts(stats, trades) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Create new charts
            charts.orderDistribution = createOrderDistributionChart(stats);
            charts.tpslStats = createTPSLChart(stats);
            charts.dailyProfit = createProfitChart(trades);
            charts.symbolPerformance = createSymbolPerformanceChart(stats);
        }

        function createOrderDistributionChart(stats) {
            const ctx = document.getElementById('orderDistribution').getContext('2d');
            return new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Buy Orders', 'Sell Orders'],
                    datasets: [{
                        data: [stats.buyTrades, stats.sellTrades],
                        backgroundColor: ['#36A2EB', '#FF6384']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTPSLChart(stats) {
            const ctx = document.getElementById('tpslStats').getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Take Profit', 'Stop Loss', 'Manual Close'],
                    datasets: [{
                        label: 'Number of Trades',
                        data: [stats.tpHits, stats.slHits, stats.manualCloses],
                        backgroundColor: ['#4CAF50', '#f44336', '#9C27B0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createProfitChart(trades) {
            let cumulativeProfit = 0;
            const profitData = trades.map(trade => {
                cumulativeProfit += trade.profit;
                return {
                    date: trade.date.split(' ')[0],
                    profit: cumulativeProfit
                };
            });

            const ctx = document.getElementById('dailyProfit').getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: profitData.map(d => d.date),
                    datasets: [{
                        label: 'Cumulative Profit',
                        data: profitData.map(d => d.profit),
                        borderColor: '#2196F3',
                        fill: true,
                        backgroundColor: 'rgba(33, 150, 243, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: value => `$${value.toFixed(2)}`
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: context => `Profit: $${context.parsed.y.toFixed(2)}`
                            }
                        }
                    }
                }
            });
        }

        function createSymbolPerformanceChart(stats) {
            const symbolData = Object.entries(stats.symbolStats).map(([symbol, data]) => ({
                symbol,
                profit: data.totalProfit,
                trades: data.trades
            }));

            const ctx = document.getElementById('symbolPerformance').getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: symbolData.map(d => d.symbol),
                    datasets: [{
                        label: 'Total Profit',
                        data: symbolData.map(d => d.profit),
                        backgroundColor: symbolData.map(d => d.profit >= 0 ? '#4CAF50' : '#f44336'),
                        yAxisID: 'y'
                    }, {
                        label: 'Number of Trades',
                        data: symbolData.map(d => d.trades),
                        type: 'line',
                        borderColor: '#FF9800',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                callback: value => `$${value.toFixed(2)}`
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadTradingData);

        // Add auto-refresh every 5 minutes
        setInterval(loadTradingData, 5 * 60 * 1000);
    </script>
</body>
</html>